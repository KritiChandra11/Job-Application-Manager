{% extends "base.html" %}

{% block title %}Dashboard - Job  Tracker{% endblock %}

{% block extra_css %}
<style>
    .fc-event {
        cursor: pointer;
    }
    .status-pending {
        background-color: #fd7e14;
        border-color: #fd7e14;
    }
    .status-done {
        background-color: #198754;
        border-color: #198754;
    }
    .status-cancelled {
        background-color: #dc3545;
        border-color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12 text-center">
        <h1 class="display-4 mb-4">Job Tracker</h1>
        <div class="d-flex justify-content-center mb-4">
            <ul class="nav nav-pills">
                <li class="nav-item">
                    <a class="nav-link active" href="{{ url_for('dashboard') }}">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('portals') }}">Job Portals</a>
                </li>
            </ul>
        </div>
    </div>
    <div class="col-md-12 text-end">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEventModal">
            <i class="bi bi-plus-circle"></i> Add Interview/Job
        </button>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card shadow">
            <div class="card-body">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>

<!-- Event Details Modal -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalLabel">Event Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="eventDetails">
                    <h4 id="eventTitle" class="mb-3"></h4>
                    <p><strong>Company:</strong> <span id="eventCompany"></span></p>
                    <p><strong>Date & Time:</strong> <span id="eventDate"></span></p>
                    <p><strong>Status:</strong> <span id="eventStatus" class="badge"></span></p>
                    <p><strong>Description:</strong></p>
                    <p id="eventDescription"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="markAsDoneBtn">Mark as Done</button>
                <button type="button" class="btn btn-primary" id="editEventBtn">Edit</button>
                <button type="button" class="btn btn-danger" id="deleteEventBtn">Delete</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Event Modal -->
<div class="modal fade" id="addEventModal" tabindex="-1" aria-labelledby="addEventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addEventModalLabel">Add Interview/Job</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="eventForm">
                    <input type="hidden" id="eventId">
                    <div class="mb-3">
                        <label for="title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="company" class="form-label">Company</label>
                        <input type="text" class="form-control" id="company" required>
                    </div>
                    <div class="mb-3">
                        <label for="date" class="form-label">Date & Time</label>
                        <input type="datetime-local" class="form-control" id="date" required>
                    </div>
                    <div class="mb-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status">
                            <option value="Pending">Pending</option>
                            <option value="Done">Done</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveEventBtn">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this event?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let calendar;
        let currentEvent = null;
        
        // Initialize calendar
        const calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: function(fetchInfo, successCallback, failureCallback) {
                fetch('/api/events')
                    .then(response => response.json())
                    .then(data => {
                        const events = data.map(event => {
                            return {
                                id: event.id,
                                title: `${event.title} - ${event.company}`,
                                start: event.date,
                                allDay: false,
                                className: `status-${event.status.toLowerCase()}`,
                                extendedProps: {
                                    company: event.company,
                                    description: event.description,
                                    status: event.status
                                }
                            };
                        });
                        successCallback(events);
                    })
                    .catch(error => {
                        console.error('Error fetching events:', error);
                        failureCallback(error);
                    });
            },
            eventClick: function(info) {
                const event = info.event;
                
                // Set current event for modal actions
                currentEvent = {
                    id: event.id,
                    title: event.title.split(' - ')[0],
                    company: event.extendedProps.company,
                    date: event.start,
                    status: event.extendedProps.status,
                    description: event.extendedProps.description
                };
                
                // Populate event details modal
                document.getElementById('eventTitle').textContent = currentEvent.title;
                document.getElementById('eventCompany').textContent = currentEvent.company;
                document.getElementById('eventDate').textContent = formatDateTime(currentEvent.date);
                
                const statusBadge = document.getElementById('eventStatus');
                statusBadge.textContent = currentEvent.status;
                statusBadge.className = 'badge';
                
                if (currentEvent.status === 'Pending') {
                    statusBadge.classList.add('bg-warning');
                    document.getElementById('markAsDoneBtn').style.display = 'block';
                } else if (currentEvent.status === 'Done') {
                    statusBadge.classList.add('bg-success');
                    document.getElementById('markAsDoneBtn').style.display = 'none';
                } else if (currentEvent.status === 'Cancelled') {
                    statusBadge.classList.add('bg-danger');
                    document.getElementById('markAsDoneBtn').style.display = 'none';
                }
                
                document.getElementById('eventDescription').textContent = currentEvent.description || 'No description provided.';
                
                // Show the event details modal
                const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
                eventModal.show();
            }
        });
        
        calendar.render();
        
        // Format date and time
        function formatDateTime(date) {
            return new Date(date).toLocaleString();
        }
        
        // Handle save event button
        document.getElementById('saveEventBtn').addEventListener('click', function() {
            const eventForm = document.getElementById('eventForm');
            const eventId = document.getElementById('eventId').value;
            
            // Validate form
            if (!eventForm.checkValidity()) {
                eventForm.reportValidity();
                return;
            }
            
            const eventData = {
                title: document.getElementById('title').value,
                company: document.getElementById('company').value,
                date: document.getElementById('date').value,
                status: document.getElementById('status').value,
                description: document.getElementById('description').value
            };
            
            // Determine if this is an add or edit operation
            let url = '/api/events';
            let method = 'POST';
            
            if (eventId) {
                url = `/api/events/${eventId}`;
                method = 'PUT';
            }
            
            // Save the event
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(eventData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to save event');
                }
                return response.json();
            })
            .then(data => {
                // Close the modal and refresh the calendar
                const modal = bootstrap.Modal.getInstance(document.getElementById('addEventModal'));
                modal.hide();
                calendar.refetchEvents();
                
                // Reset the form
                eventForm.reset();
                document.getElementById('eventId').value = '';
            })
            .catch(error => {
                console.error('Error saving event:', error);
                alert('Failed to save event. Please try again.');
            });
        });
        
        // Handle edit event button
        document.getElementById('editEventBtn').addEventListener('click', function() {
            if (!currentEvent) return;
            
            // Close the event details modal
            bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
            
            // Populate the edit form
            document.getElementById('eventId').value = currentEvent.id;
            document.getElementById('title').value = currentEvent.title;
            document.getElementById('company').value = currentEvent.company;
            document.getElementById('status').value = currentEvent.status;
            document.getElementById('description').value = currentEvent.description || '';
            
            // Format date for datetime-local input
            const date = new Date(currentEvent.date);
            const formattedDate = date.toISOString().slice(0, 16);
            document.getElementById('date').value = formattedDate;
            
            // Update modal title
            document.getElementById('addEventModalLabel').textContent = 'Edit Interview/Job';
            
            // Show the add/edit modal
            const addEventModal = new bootstrap.Modal(document.getElementById('addEventModal'));
            addEventModal.show();
        });
        
        // Handle mark as done button
        document.getElementById('markAsDoneBtn').addEventListener('click', function() {
            if (!currentEvent) return;
            
            fetch(`/api/events/${currentEvent.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: 'Done' })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to update event status');
                }
                return response.json();
            })
            .then(data => {
                // Close the modal and refresh the calendar
                bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                calendar.refetchEvents();
            })
            .catch(error => {
                console.error('Error updating event status:', error);
                alert('Failed to update event status. Please try again.');
            });
        });
        
        // Handle delete event button
        document.getElementById('deleteEventBtn').addEventListener('click', function() {
            if (!currentEvent) return;
            
            // Close the event details modal
            bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
            
            // Show the delete confirmation modal
            const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            deleteConfirmModal.show();
        });
        
        // Handle confirm delete button
        document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
            if (!currentEvent) return;
            
            fetch(`/api/events/${currentEvent.id}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to delete event');
                }
                return response.json();
            })
            .then(data => {
                // Close the modal and refresh the calendar
                bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
                calendar.refetchEvents();
            })
            .catch(error => {
                console.error('Error deleting event:', error);
                alert('Failed to delete event. Please try again.');
            });
        });
        
        // Reset form when add event modal is opened
        document.getElementById('addEventModal').addEventListener('show.bs.modal', function(event) {
            if (!event.relatedTarget) return; // Don't reset if opened from edit button
            
            document.getElementById('eventForm').reset();
            document.getElementById('eventId').value = '';
            document.getElementById('addEventModalLabel').textContent = 'Add Interview/Job';
        });
    });
</script>
{% endblock %}